{"version":3,"file":"request.js","sources":["utils/request.js"],"sourcesContent":["import CryptoJS from 'crypto-js'\r\nimport config from '@/utils/config'\r\nimport toast from '@/utils/toast'\r\n\r\nconst buildHeader = (method, data) => {\r\n\tconsole.log('buildHeader params ->', method, typeof(data))\r\n\tvar version = '1.0';\r\n\tvar clientID = '9f823d76-5a8f-4ca3-94bc-c80febdd6501';\r\n\tvar clientSecret = '96a9c3b06d93402a743605eedfbe72106fe1e967f1ec5f5bed7e8da90a033f1a';\r\n\tvar nonce = CryptoJS.MD5(parseInt(Math.random() * 32769 + 32768, 10).toString()).toString();\r\n\tvar timestamp = (Date.parse(new Date()) / 1000).toString();\r\n\t// Body\r\n\tvar body = ''\r\n\tif (method == 'POST') {\r\n\t\tif (typeof(data) == 'object') {\r\n\t\t\tdata = JSON.stringify(data)\r\n\t\t}\r\n\t    body = CryptoJS.enc.Base64.stringify(CryptoJS.enc.Utf8.parse(data))\r\n\t}\r\n\t\r\n\tvar plainText = clientID + nonce + timestamp + version + body;\r\n\tvar sign = CryptoJS.HmacSHA256(plainText, clientSecret).toString();\r\n\tconsole.log('plainText:' + plainText, 'sign:' + sign)\r\n\r\n\tvar headers = {\r\n\t\t'Client-ID': clientID,\r\n\t\t'Nonce': nonce,\r\n\t\t'Timestamp': timestamp,\r\n\t\t'Signature': sign,\r\n\t\t'Version': version,\r\n\t}\r\n\t\r\n\t// token\r\n\tvar token = uni.getStorageSync('token')\r\n\tif (token) {\r\n\t    headers['Token'] = token\r\n\t}\r\n\r\n\treturn headers\r\n}\r\n\r\nconst access = (response) => {\r\n\tswitch (response.statusCode) {\r\n\t\tcase 200:\r\n\t\t\tif (typeof(response.data) == 'object' && response.data.code != 200) {\r\n\t\t\t\ttoast.error(response.data.message)\r\n\t\t\t\tif (response.data.code == 401) {\r\n\t\t\t\t\tuni.navigateTo({ url: '/pages/auth/login' })\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// 接口响应成功\r\n\t\t\t\t// todo\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\tcase 400:\r\n\t\t\ttoast.error('400 Bad Request')\r\n\t\t\tbreak;\r\n\t\tcase 401:\r\n\t\t\ttoast.error('401 Unauthorized')\r\n\t\t\tbreak;\r\n\t\tcase 404:\r\n\t\t\ttoast.error('404 Not Found')\r\n\t\t\tbreak;\r\n\t\tcase 500:\r\n\t\t\ttoast.error('500 Internal Server Error')\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\t// todo\r\n\t}\r\n}\r\n\r\n// 拦截器\r\nuni.addInterceptor('request', {\r\n    invoke(args) {\r\n        // request 触发前拼接 url \r\n        args.url = config.API_URL + args.url\r\n        // 超时时间\r\n        args.timeout = 150000\r\n        // header\r\n        args.header = buildHeader(args.method, args.data)\r\n    },\r\n    success(response) {\r\n        // 请求成功后，修改code值为1\r\n        // args.data.code = 1\r\n\t\tconsole.log('interceptor-success',response)\r\n        access(response)\r\n    }, \r\n    fail(err) {\r\n        console.log('interceptor-fail',err)\r\n        access(err)\r\n    }, \r\n    complete(response) {\r\n        // console.log('interceptor-complete',response)\r\n    }\r\n})\r\n\r\nexport default {\r\n    send(options) {\r\n        return uni.request(options)\r\n    }\r\n}"],"names":["uni","CryptoJS","toast","config"],"mappings":";;;;AAIA,MAAM,cAAc,CAAC,QAAQ,SAAS;AACrCA,gBAAA,MAAA,MAAA,OAAA,yBAAY,yBAAyB,QAAQ,OAAO,IAAK;AACzD,MAAI,UAAU;AACd,MAAI,WAAW;AACf,MAAI,eAAe;AACnB,MAAI,QAAQC,cAAQ,SAAC,IAAI,SAAS,KAAK,OAAM,IAAK,QAAQ,OAAO,EAAE,EAAE,SAAQ,CAAE,EAAE,SAAQ;AACzF,MAAI,aAAa,KAAK,MAAM,oBAAI,MAAM,IAAI,KAAM;AAEhD,MAAI,OAAO;AACX,MAAI,UAAU,QAAQ;AACrB,QAAI,OAAO,QAAS,UAAU;AAC7B,aAAO,KAAK,UAAU,IAAI;AAAA,IAC1B;AACE,WAAOA,cAAQ,SAAC,IAAI,OAAO,UAAUA,uBAAS,IAAI,KAAK,MAAM,IAAI,CAAC;AAAA,EACrE;AAED,MAAI,YAAY,WAAW,QAAQ,YAAY,UAAU;AACzD,MAAI,OAAOA,cAAAA,SAAS,WAAW,WAAW,YAAY,EAAE;AACxDD,6DAAY,eAAe,WAAW,UAAU,IAAI;AAEpD,MAAI,UAAU;AAAA,IACb,aAAa;AAAA,IACb,SAAS;AAAA,IACT,aAAa;AAAA,IACb,aAAa;AAAA,IACb,WAAW;AAAA,EACX;AAGD,MAAI,QAAQA,cAAAA,MAAI,eAAe,OAAO;AACtC,MAAI,OAAO;AACP,YAAQ,OAAO,IAAI;AAAA,EACtB;AAED,SAAO;AACR;AAEA,MAAM,SAAS,CAAC,aAAa;AAC5B,UAAQ,SAAS,YAAU;AAAA,IAC1B,KAAK;AACJ,UAAI,OAAO,SAAS,QAAS,YAAY,SAAS,KAAK,QAAQ,KAAK;AACnEE,oBAAAA,MAAM,MAAM,SAAS,KAAK,OAAO;AACjC,YAAI,SAAS,KAAK,QAAQ,KAAK;AAC9BF,wBAAAA,MAAI,WAAW,EAAE,KAAK,oBAAmB,CAAE;AAAA,QAC3C;AAAA,MAID;AACD;AAAA,IACD,KAAK;AACJE,kBAAK,MAAC,MAAM,iBAAiB;AAC7B;AAAA,IACD,KAAK;AACJA,kBAAK,MAAC,MAAM,kBAAkB;AAC9B;AAAA,IACD,KAAK;AACJA,kBAAK,MAAC,MAAM,eAAe;AAC3B;AAAA,IACD,KAAK;AACJA,kBAAK,MAAC,MAAM,2BAA2B;AACvC;AAAA,EAGD;AACF;AAGAF,cAAAA,MAAI,eAAe,WAAW;AAAA,EAC1B,OAAO,MAAM;AAET,SAAK,MAAMG,aAAAA,OAAO,UAAU,KAAK;AAEjC,SAAK,UAAU;AAEf,SAAK,SAAS,YAAY,KAAK,QAAQ,KAAK,IAAI;AAAA,EACnD;AAAA,EACD,QAAQ,UAAU;AAGpBH,kBAAAA,MAAA,MAAA,OAAA,0BAAY,uBAAsB,QAAQ;AACpC,WAAO,QAAQ;AAAA,EAClB;AAAA,EACD,KAAK,KAAK;AACNA,kBAAAA,MAAA,MAAA,OAAA,0BAAY,oBAAmB,GAAG;AAClC,WAAO,GAAG;AAAA,EACb;AAAA,EACD,SAAS,UAAU;AAAA,EAElB;AACL,CAAC;AAED,MAAe,UAAA;AAAA,EACX,KAAK,SAAS;AACV,WAAOA,cAAG,MAAC,QAAQ,OAAO;AAAA,EAC7B;AACL;;"}